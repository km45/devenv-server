name: CI

on: [push, pull_request]

jobs:
  multipass_test_jammy:
    # Use macOS instance for VirtualBox
    # because nested virtualization is not supported for Ubuntu instances
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v3
      - run: brew install --cask multipass
      - name: Wait 30 seconds for multipassd ready
        run: sleep 30
      - run: multipass set local.driver=virtualbox
      - name: Wait 30 seconds for multipassd ready
        run: sleep 30
      - run: multipass launch 22.04 --cloud-init src/multipass/cloud-init.yml --name test-jammy
      - run: multipass mount ./src/playbooks test-jammy:/multipass/playbooks
      - run: multipass exec test-jammy -- ansible-playbook /multipass/playbooks/multipass.yml
      - run: multipass exec test-jammy -- ansible-playbook /multipass/playbooks/multipass.yml --tags 'test'
        name: test for current session
      - run: multipass restart test-jammy
      - run: multipass exec test-jammy -- ansible-playbook /multipass/playbooks/multipass.yml --tags 'test,test2'
        name: test after rebooting
  test_cplusplus:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=cplusplus
  test_git:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=git
  test_hadolint:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=hadolint
  test_nkf:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=nkf
  test_prompt:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=prompt
  test_python:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=python
  test_rust:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=rust
  test_shellcheck:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=shellcheck
  test_zip:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make test ROLE=zip
  # lint:
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - uses: actions/checkout@v3
  #     - run: make up
  #     - run: make lint TTY=false
  #     - run: make down
  lint2:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: pip
      - run: make sync
      - run: make lint2
  status_check:
    runs-on: ubuntu-22.04
    needs:
      - multipass_test_jammy
      - test_cplusplus
      - test_git
      - test_hadolint
      - test_nkf
      - test_prompt
      - test_python
      - test_rust
      - test_shellcheck
      - test_zip
      # - lint
      - lint2
    steps:
      - run: echo 'pass'
